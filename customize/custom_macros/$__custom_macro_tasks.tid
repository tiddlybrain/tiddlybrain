created: 20191031101112843
creator: yuzijie
modified: 20220823140927307
modifier: yuzijie
tags: $:/tags/Macro customized
title: $:/custom/macro/tasks
type: text/vnd.tiddlywiki

\define task-state-prefix() $:/task-state/$(currentTiddler)$/

\define tasks-today()
<span style="font-size:smaller;font-weight:500;color:#333;">
<$list filter="[prefix<task-state-prefix>limit[1]]" emptyMessage="🏆" variable="NONE">
<$list filter="[prefix<task-state-prefix>text[waiting]limit[1]]" variable="NONE">
🏆 <$count filter="[prefix<task-state-prefix>text[waiting]]"/>
</$list>
<$list filter="[prefix<task-state-prefix>text[deadline]limit[1]]" variable="NONE">
⏱️ <$count filter="[prefix<task-state-prefix>text[deadline]]"/>
</$list>
<$list filter="[prefix<task-state-prefix>!text[waiting]!text[deadline]limit[1]]" variable="NONE">
⚔️ <$count filter="[prefix<task-state-prefix>!text[waiting]!text[deadline]]"/>
</$list>
</$list>
</span>
\end

\define task-list-button(color, date)
<$set name="task-id" filter="[all[current]split[/]nth[3]]" select="0">@@color:#333;{{!!remark}}@@
<$set name="drag" filter="[all[current]!text[waiting]!text[open]]" value=<<currentTiddler>> emptyValue="">
<$button dragTiddler=<<drag>> to=<<task-id>> class="tc-btn-invisible" style="white-space:nowrap;color:$color$;" message="tm-copy-to-clipboard" param={{!!caption}}>''{{!!caption}}''</$button>
</$set>
<$set name="start" filter="[<task-id>getTDate{!!caption}]" select="0">
<$list filter="[{!!date}match<start>]" emptyMessage="""<$button class="tc-btn-invisible"><$action-setfield date=<<start>>/>Update Date</$button>""" variable="NONE">
<$reveal default="$date$" type="match" text="left" style="color:green;"><$macrocall $name="days-left" deadline={{!!date}}/></$reveal>
<$reveal default="$date$" type="match" text="passed" style="color:green;"><$macrocall $name="days-passed" start={{!!date}}/></$reveal>
</$list>
</$set>
<$button class="tc-btn-invisible" dragTiddler=<<task-id>> message="tm-copy-to-clipboard" param={{!!caption}}>
<$action-sendmessage $message="tm-edit-tiddler" $param=<<task-id>>/>(<$transclude tiddler=<<task-id>> field="caption"/>)
</$button>
<$list filter="[all[current]get[plan]enlist-input[]nth[2]]" variable="NONE">
<$button class="tc-btn-invisible">&times;<$action-listops $field="plan" $subfilter="-[<dt>]"/></$button>
</$list>
</$set>
\end

\define task-list-open() <<task-list-button "brown" "left">>
\define task-list-doing() <<task-list-button "green" "passed">>
\define task-list-waiting() <<task-list-button "#009dd9" "passed">>
\define task-list-deadline() <<task-list-button "#cd23d8" "left">>

\define task-list()
<$list filter="[[$:/temp/task-list]is[tiddler]]">
<$button><$action-deletetiddler $tiddler="$:/temp/task-list"/>&times; <$transclude tiddler={{$:/temp/task-list}} field="caption"/></$button>
</$list>
<$checkbox tiddler="$:/temp/task/waiting" field="text" checked="yes" unchecked="no" default="yes"> Milestone</$checkbox>
<$checkbox tiddler="$:/temp/task/deadline" field="text" checked="yes" unchecked="no" default="yes"> Deadline</$checkbox>
<$checkbox tiddler="$:/temp/task/open" field="text" checked="yes" unchecked="no" default="yes"> Open</$checkbox>
<$checkbox tiddler="$:/temp/task/doing" field="text" checked="yes" unchecked="no" default="yes"> Doing</$checkbox>
<$set name="today" value=<<now YYYY0MM0DD>>><dl class="task-list">
<$list filter="[prefix[$:/task-state/]search:title:literal{$:/temp/task-list}!has[plan]]"><dd><<task-list-waiting>></dd></$list>
<$list filter="[prefix[$:/task-state/]search:title:literal{$:/temp/task-list}get[plan]enlist-input[]each:value[]] [<today>] +[sort[]]" variable="dt">
<$droppable actions="""<$action-listops $tiddler=<<actionTiddler>> $field="plan" $subfilter="[<dt>]"/><$action-setfield $tiddler=<<actionTiddler>> category="Other"/>""" tag="dt">
<$set name="date-title" filter="[<dt>format:date[YYYY-0MM-0DD DDD]]" select="0"><<date-title>></$set>
@@color:#333;<$count filter="[prefix[$:/task-state/]contains:plan<dt>]"/>@@
<$list filter="[<dt>match<today>]">^^@@color:red;Today@@^^</$list>
</$droppable>
<$list filter="[[$:/temp/task/waiting]!text[no]]" variable="NONE">
<$list filter="[prefix[$:/task-state/]search:title:literal{$:/temp/task-list}text[waiting]contains:plan<dt>]"><dd><<task-list-waiting>></dd></$list>
</$list>
<$list filter="[[$:/temp/task/deadline]!text[no]]" variable="NONE">
<$list filter="[prefix[$:/task-state/]search:title:literal{$:/temp/task-list}text[deadline]contains:plan<dt>]"><dd><<task-list-deadline>></dd></$list>
</$list>
<$list filter="[[$:/temp/task/open]!text[no]]" variable="NONE">
<$list filter="[prefix[$:/task-state/]search:title:literal{$:/temp/task-list}text[open]contains:plan<dt>]"><dd><<task-list-open>></dd></$list>
</$list>
<$list filter="[[$:/temp/task/doing]!text[no]]" variable="NONE">
<$list filter="[prefix[$:/task-state/]search:title:literal{$:/temp/task-list}text[doing]contains:plan<dt>]"><dd><<task-list-doing>></dd></$list>
</$list>
</$list>
</dl></$set>
\end

\define date-pillar-task() <$button to=<<currentTiddler>> class="tc-btn-invisible" style="background-color:$(color)$;">{{!!caption}}</$button>

\define date-pillar(date, today)
<$set name="container-class" filter="[<__date__>match<__today__>]" value="dp-container today" emptyValue="dp-container">
<$set name="journal-title" filter="[<__date__>format:date[YYYY-0MM-0DD]]" select="0"><$droppable actions=<<droppable-date-action>> tag="div" class=<<container-class>>>
<div class="dp-title"><$set name="dp-title" value=<<format-date "$date$" "MM-DD ddd">>>
<$list filter="[<journal-title>is[tiddler]]" emptyMessage="""<$button class="tc-btn-invisible">//<<dp-title>>//
<$action-createtiddler $basetitle=<<journal-title>> tags="Tasks/Journal" type="application/x-tiddler-dictionary" date=<<now 'YYYY0MM0DD'>> caption=<<dp-title>> text="日记: <<snippet>>"/>
</$button>""">
<$button set="$:/temp/plan/date" setTo=<<__date__>> class="tc-btn-invisible tc-tiddlylink" style="text-align:center;">
<<dp-title>><$action-setfield $tiddler="$:/state/tasks-924879352" text="Tasks/Actions"/>
</$button>
</$list>
</$set></div>
<div class="dp-content"><ol><$list filter="[<journal-title>indexes[]tag[Task]!sort[color]]"><li>
<$set name="color" filter="[all[current]has[color]]" value={{!!color}} emptyValue="transparent"><<date-pillar-task>></$set>
</li></$list></ol></div>
</$droppable></$set>
</$set>
\end

\define priority-dot() <span class="dot" style="background-color:$(color)$;padding:2px 8px 3px;">@@color:#333;<<currentTiddler>>@@</span>

\define color-palette(color, bg-color, name)
<$droppable actions="""<$action-setfield $tiddler=<<actionTiddler>> color="$color$"/>""">
<span class="dot" style="background-color:$bg-color$;padding:1px 8px 2px 8px;color:#333;">$name$</span>
</$droppable>
\end

\define weekly-plan(date)
<div style="display:flex;margin-bottom:12px;">
<$set name="sunday" filter="[<__date__>getSunday[]]" select="0"><$list filter="[range[0],[6]]" variable="num">
<$set name="current-date" filter="[<sunday>nextDay<num>]" select="0"><$macrocall $name="date-pillar" date=<<current-date>> today=<<__date__>>/></$set>
</$list></$set>
</div>
<div style="border:1px solid #e0e0e0;padding:10px 20px;background:#fafafa;border-radius:7px;">
<div style="margin:3px 0 12px 0;">
<<color-palette color:"#ffd47d" bg-color:"#ffd47d" name:"Daily">>
<<color-palette color:"#ffbea1" bg-color:"#ffbea1" name:"Important">>
<<color-palette color:"#c3ffa2" bg-color:"#c3ffa2" name:"Weekly">>
<<color-palette color:"" bg-color:"#c9fffe" name:"On Hold">>
</div>
<$list filter="[prefix[$:/task-state/]split[/]tag[Task]each:value[]!sort[color]]"><div style="margin:0.3em 0;">
<$set name="color" filter="[all[current]has[color]]" value={{!!color}} emptyValue="#c9fffe">
<$button set="$:/temp/task-list" setTo={{!!title}} class="tc-btn-invisible"><<priority-dot>></$button>
</$set>
<$button to={{!!title}} dragTiddler={{!!title}} class="tc-btn-invisible">{{!!caption}}
<span style="color:green;">
<$list filter="[prefix[$:/task-state/]text[deadline]search:title:literal<currentTiddler>sort[date]first[]get[date]]">
- <$macrocall $name="days-left" deadline=<<currentTiddler>>/> 💣
</$list>
<$list filter="[prefix[$:/task-state/]text[open]search:title:literal<currentTiddler>sort[date]first[]get[date]]">
- <$macrocall $name="days-left" deadline=<<currentTiddler>>/> 🔥
</$list>
<$list filter="[prefix[$:/task-state/]text[doing]search:title:literal<currentTiddler>sort[date]first[]get[date]]">
- <$macrocall $name="days-passed" start=<<currentTiddler>>/> 🚀
</$list>
</span>
</$button>
</div></$list>
</div>
\end

; 1. 列出计划今天开始的任务
: `<<tasks-today>>`
; 2. 单个任务按钮
: `<<task-list-button color:"颜色" date:"left/passed">>`
; 3. 所有任务清单
: `<<task-list>>`
; 4. 用于创建和修改 Tasks Journal
: `<<date-pillar date:"相对日期 YYYY0MM0DD" today:"基准日期 YYYY0MM0DD">>`
; 5. 用于做周计划
: `<<weekly-plan date:"基准日期">>`