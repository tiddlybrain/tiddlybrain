caption: ChatGPT
created: 20240707102007118
creator: yuzijie
modified: 20240716185257358
modifier: yuzijie
tags: customized
title: $:/custom/model/ChatGPT
type: text/vnd.tiddlywiki

\procedure call-api()

\procedure completion-get-json()
<$list filter="[<status>compare:number:gteq[200]compare:number:lteq[299]]" variable="NONE" emptyMessage="""<$set name="message" filter="[<data>jsonget[error],[message]]" emptyValue="check your network" select="0"><$action-setfield $tiddler="$:/temp/api/response" text=`Error Code $(status)$ - $(message)$`/></$set>""">
<$set name="message" filter="[<data>jsonget[choices],[0],[message],[content]]" select="0">
<$action-setfield $tiddler="$:/temp/api/response" text=<<message>> type="text/x-markdown"/>
<$let timestamp=<<now "0hh:0mm:0ss">>>
<$action-createtiddler $basetitle="$:/temp/api/history" type="application/json" caption=<<timestamp>>>
<$action-setfield $tiddler=<<createTiddler-title>> $index="role" $value="user"/>
<$action-setfield $tiddler=<<createTiddler-title>> $index="content" $value={{$:/temp/api/request}}/>
<$action-setfield $tiddler=<<createTiddler-title>> $index="type" $value="text/vnd.tiddlywiki"/>
</$action-createtiddler>
<$action-createtiddler $basetitle="$:/temp/api/history" type="application/json" caption=<<timestamp>>>
<$action-setfield $tiddler=<<createTiddler-title>> $index="role" $value="assistant"/>
<$action-setfield $tiddler=<<createTiddler-title>> $index="content" $value=<<message>>/>
<$action-setfield $tiddler=<<createTiddler-title>> $index="type" $value="text/x-markdown"/>
</$action-createtiddler>
</$let>
</$set>
</$list>
\end completion-get-json

<$let api-key={{$:/config/openaiApiKey}} model={{$:/config/aiModels}} instructions={{{ [{$:/temp/instructions}get[text]jsonstringify[]] }}} userInput={{{ [[$:/temp/api/request]get[text]jsonstringify[]] }}} default={{{ [[$:/config/defaultInstructions/ChatGPT]get[text]jsonstringify[]] }}}>
<$set name="chatHistory" filter="[[$:/state/api/history]get[text]match[yes]]" value={{{ [prefix[$:/temp/api/history]get[text]] +[join[,]addsuffix[,]] }}} emptyValue="">
<$action-setfield $tiddler="$:/temp/api/response" text="Waiting for response..."/>
<$action-sendmessage $message="tm-http-request" url="https://api.openai.com/v1/chat/completions" method="POST"
  oncompletion=<<completion-get-json>>
  header-Content-Type='application/json'
  header-Authorization=`Bearer $(api-key)$`
  body=`{"model":"$(model)$","messages":[{"role":"system","content":"$(instructions)$\n\n$(default)$"},$(chatHistory)${"role":"user","content":"$(userInput)$"}]}`
/>
</$set>
</$let>

\end call-api

<section class="ai"><h3>Instructions <$list filter="[[$:/temp/api/request]type[text/x-markdown]]"><$md-to-tid-button title={{!!title}} type={{!!type}}/></$list></h3>
<$edit-text tiddler="$:/temp/api/request" tag="textarea" class="edit-area tc-edit-texteditor"/>
<table style="width:100%;margin:0;"><tbody>
<tr><th>Choose Model</th><th>Custom Instructions</th></tr>
<tr style="text-align:center;">
<td><$select tiddler='$:/config/aiModels'>
<$list filter="[list[$:/config/aiModels]]"><option>{{!!title}}</option></$list>
</$select></td>
<td><$select tiddler="$:/temp/instructions" default="">
<option value="">No Instructions</option>
<$list filter="[all[tiddlers]note[Instruction]get[belongs.to]unique[]]"><optgroup label={{!!caption}}>
<$list filter='[all[tiddlers]note[Instruction]belongs.to{!!title}]'><option value={{!!title}}>{{!!caption}}</option></$list>
</optgroup></$list>
</$select>
<$button tag="span">⚙️
<$action-sendmessage $message="tm-modal" $param="$:/custom/template/normal-modal" mTitle="$:/custom/ui/ControlPanel/CustomInstructions"/>
</$button>
</td>
</tr>
</tbody></table>
</section>

<$reveal type="match" state="$:/temp/api/response" text="Waiting for response..." tag="section" class="ai center" style="margin:1.5em 0;">
<$button actions="""<$action-deletetiddler $filter="[[$:/temp/api/response]]"/>""">Cancel Request</$button>
</$reveal>

<$reveal type="nomatch" state="$:/temp/api/response" text="Waiting for response..." tag="section" class="ai center" style="margin:1.5em 0;">
<$list filter="[{$:/temp/api/response}!is[blank]]" emptyMessage="<$button actions=<<call-api>>>Ask ChatGPT</$button>
<$checkbox tiddler='$:/state/api/history' field='text' checked='yes' unchecked='no' default='no'> Chat History</$checkbox>">
<$list filter="[<sidebar>!match[yes]]" variable="NONE">
<$button actions=<<insert-as-text>>>Insert as Text</$button>
<$let template={{$:/config/defaultTemplate}}><$button actions=<<insert-as-tiddler>>>Insert as New Tiddler</$button></$let>
</$list>
<$list filter="[<sidebar>match[yes]]" variable="NONE">
<$let template={{$:/config/defaultTemplate}}><$button actions=<<save-as-tiddler>>>Save as New Tiddler</$button></$let>
</$list>
<$button message="tm-copy-to-clipboard" param={{$:/temp/api/response}}>Copy to Clipboard</$button>
<$button actions=<<call-api>>>Ask Again</$button>
<$checkbox tiddler="$:/state/api/history" field="text" checked="yes" unchecked="no" default="no"> Chat History</$checkbox>
</$list>
</$reveal>

<section class="ai"><h3>Results <$list filter="[[$:/temp/api/response]type[text/x-markdown]]"><$md-to-tid-button title={{!!title}} type={{!!type}}/></$list></h3>
<$edit-text tiddler="$:/temp/api/response" tag="textarea" class="edit-area tc-edit-texteditor"/>
</section>

<$list filter="[prefix[$:/temp/api/history]limit[1]]"><section class="ai">
<h3>History <$button style="font-size:small;"><$action-deletetiddler $filter="[prefix[$:/temp/api/history]]"/>Clear History</$button></h3>
<$list filter="[prefix[$:/temp/api/history]!sort[created]]">
<$set name="summary" filter="[all[current]get[caption]] [all[current]getindex[role]] [all[current]getindex[content]] +[join[ - ]]" select="0">
<$details summary=<<summary>>>
<$button set="$:/temp/api/request" setTo={{{ [all[current]getindex[content]] }}}><$action-setfield $tiddler="$:/temp/api/request" type={{{ [all[current]getindex[type]] }}}/>Set to Instructions</$button>
<$button set="$:/temp/api/response" setTo={{{ [all[current]getindex[content]] }}}><$action-setfield $tiddler="$:/temp/api/response" type={{{ [all[current]getindex[type]] }}}/>Set to Results</$button>
<$button><$action-deletetiddler $tiddler=<<currentTiddler>>/>Delete This</$button>
<div class="history"><$transclude $tiddler={{!!title}} $index="content" $mode="block" $type="text/plain"/></div>
</$details>
</$set>
</$list>
</section></$list>